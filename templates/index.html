<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kiwi Trading Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="brand">ğŸ¥ Kiwi Desk</div>
        <button class="tab-btn active" data-tab="tab-overview">ëŒ€ì‹œë³´ë“œ</button>
        <button class="tab-btn" data-tab="tab-report">ë¦¬í¬íŠ¸</button>
        <button class="tab-btn" data-tab="tab-news">ë‰´ìŠ¤</button>
        <button class="tab-btn" data-tab="tab-account">ê³„ì¢Œ í˜„í™©</button>
        <button class="tab-btn" data-tab="tab-logs">ë§¤ìˆ˜/ë§¤ë„ ë¡œê·¸</button>
      </aside>

      <main class="main">
        <header class="topbar">
          <div>
            <h1>í‚¤ìœ„ íŠ¸ë ˆì´ë”© ëŒ€ì‹œë³´ë“œ</h1>
            <p class="sub">{{ market }} Â· ì‹¬í”Œ ëª¨ë‹ˆí„°ë§</p>
          </div>
          <div class="controls">
            <select id="interval">
              <option value="minute15">15m</option>
              <option value="minute60" selected>1h</option>
              <option value="minute240">4h</option>
              <option value="day">1D</option>
            </select>
            <button id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </header>

        <section id="tab-overview" class="tab active">
          <section class="cards" id="overviewCards"></section>
          <section class="panel chart-panel">
            <div class="panel-title">ê°€ê²© ì°¨íŠ¸</div>
            <div id="chart"></div>
          </section>
        </section>

        <section id="tab-report" class="tab">
          <section class="panel">
            <div class="panel-title-row">
              <div class="panel-title">ë¦¬í¬íŠ¸</div>
              <select id="reportMode">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div id="reportBox"></div>
          </section>
        </section>

        <section id="tab-news" class="tab">
          <section class="panel">
            <div class="panel-title">ì‹œì¥ ë‰´ìŠ¤ / ë¦¬ìŠ¤í¬</div>
            <div id="newsMeta" class="muted"></div>
            <div id="newsList"></div>
          </section>
        </section>

        <section id="tab-account" class="tab">
          <section class="panel">
            <div class="panel-title">ê³„ì¢Œ í˜„í™©</div>
            <div id="accountGrid" class="cards account-cards"></div>
          </section>
        </section>

        <section id="tab-logs" class="tab">
          <section class="panel">
            <div class="panel-title">ë§¤ìˆ˜/ë§¤ë„ ë¡œê·¸</div>
            <div id="tradeTable"></div>
          </section>
        </section>
      </main>
    </div>

    <script>
      const market = "{{ market }}";
      const chartEl = document.getElementById("chart");
      let chart = null;
      let candleSeries = null;
      let ma20Series = null;
      let ma200Series = null;
      let vwmaSeries = null;

      function initChartSafe() {
        if (!window.LightweightCharts) {
          chartEl.innerHTML = '<div class="muted">ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ìƒˆë¡œê³ ì¹¨(Ctrl+F5) í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
          return;
        }
        chart = LightweightCharts.createChart(chartEl, {
          layout: { background: { color: "#0e1117" }, textColor: "#dbe2f0" },
          grid: { vertLines: { color: "#1f2430" }, horzLines: { color: "#1f2430" } },
          rightPriceScale: { borderColor: "#2a3142" },
          timeScale: { borderColor: "#2a3142" },
          width: chartEl.clientWidth,
          height: 460,
        });

        candleSeries = chart.addCandlestickSeries({ upColor: "#22c55e", downColor: "#ef4444", borderVisible: false, wickUpColor: "#22c55e", wickDownColor: "#ef4444" });
        ma20Series = chart.addLineSeries({ color: "#60a5fa", lineWidth: 2 });
        ma200Series = chart.addLineSeries({ color: "#f59e0b", lineWidth: 3 });
        vwmaSeries = chart.addLineSeries({ color: "#a78bfa", lineWidth: 2 });
      }

      function num(v) { return typeof v === "number" ? Math.round(v).toLocaleString() : "-"; }

      async function loadOverview() {
        const d = await (await fetch(`/api/overview?market=${market}`)).json();
        const a = d.account || {};
        const cards = [
          ["ë¦¬ìŠ¤í¬ ëª¨ë“œ", `${d.risk_mode} (${d.risk_score ?? "-"})`],
          ["í˜„ì¬ê°€", a.price ? `${num(a.price)} KRW` : "-"],
          ["ì´ìì‚°", a.equity ? `${num(a.equity)} KRW` : "-"],
          ["í‰ê°€ìˆ˜ìµë¥ ", typeof a.pnl_pct === "number" ? `${a.pnl_pct.toFixed(2)}%` : "-"],
          ["ìµœê·¼ ì‹ í˜¸", `${d.latest_trade.side || "-"} @ ${d.latest_trade.time || "-"}`],
          ["ê±°ë˜íšŸìˆ˜", `${d.trade_count} (buy ${d.buy_count} / sell ${d.sell_count})`],
        ];
        document.getElementById("overviewCards").innerHTML = cards.map(([k, v]) => `<div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>`).join("");
      }

      async function loadChart() {
        if (!chart || !candleSeries) return;
        const interval = document.getElementById("interval").value;
        const d = await (await fetch(`/api/ohlcv?market=${market}&interval=${interval}&count=280`)).json();
        if (!d.ok) return;
        candleSeries.setData(d.candles.map((x) => ({ time: x.time, open: x.open, high: x.high, low: x.low, close: x.close })));
        ma20Series.setData(d.candles.filter((x) => x.ma20 !== null).map((x) => ({ time: x.time, value: x.ma20 })));
        ma200Series.setData(d.candles.filter((x) => x.ma200 !== null).map((x) => ({ time: x.time, value: x.ma200 })));
        vwmaSeries.setData(d.candles.filter((x) => x.vwma100 !== null).map((x) => ({ time: x.time, value: x.vwma100 })));
      }

      async function loadTrades() {
        const d = await (await fetch(`/api/trades`)).json();
        const rows = (d.rows || []).slice(0, 50);
        const html = [`<table><thead><tr><th>ì‹œê°„</th><th>êµ¬ë¶„</th><th>ê°€ê²©</th><th>ì ìˆ˜</th><th>ì‚¬ìœ </th></tr></thead><tbody>`]
          .concat(rows.map((r) => `<tr><td>${r.time}</td><td>${r.side}</td><td>${num(r.price)}</td><td>${r.score || 0}</td><td>${(r.reasons || []).join(", ")}</td></tr>`))
          .concat(["</tbody></table>"])
          .join("");
        document.getElementById("tradeTable").innerHTML = html;
      }

      async function loadReport() {
        const mode = document.getElementById("reportMode").value;
        const d = await (await fetch(`/api/report?mode=${mode}`)).json();
        const top = (d.top_reasons || []).map(([k, v]) => `${k}(${v})`).join(", ") || "-";
        document.getElementById("reportBox").innerHTML = `
          <div class="cards account-cards">
            <div class="card"><div class="k">ê¸°ê°„</div><div class="v">${d.mode}</div></div>
            <div class="card"><div class="k">ê±°ë˜ ìˆ˜</div><div class="v">${d.count}</div></div>
            <div class="card"><div class="k">ë§¤ìˆ˜/ë§¤ë„</div><div class="v">${d.buy} / ${d.sell}</div></div>
            <div class="card"><div class="k">ì†ì ˆ ì´ë²¤íŠ¸</div><div class="v">${d.stop}</div></div>
          </div>
          <div class="panel mini"><div class="k">ì£¼ìš” ì‚¬ìœ </div><div class="v">${top}</div></div>
        `;
      }

      async function loadNews() {
        const d = await (await fetch(`/api/news`)).json();
        const r = d.risk || {};
        document.getElementById("newsMeta").textContent = `risk_score=${r.risk_score ?? "-"} Â· source=${r.source ?? "-"} Â· updated=${r.updated_at ?? "-"}`;
        const items = d.items || [];
        document.getElementById("newsList").innerHTML = items.length
          ? items.map((n) => `<div class="news-item"><a href="${n.url || "#"}" target="_blank">${n.title || "(ì œëª© ì—†ìŒ)"}</a><p>${n.summary || ""}</p></div>`).join("")
          : `<div class="muted">ì•„ì§ ì €ì¥ëœ ë‰´ìŠ¤ í•­ëª©ì´ ì—†ì–´ìš”. (risk íŒŒì¼ì— items/news ë°°ì—´ ì¶”ê°€ ê°€ëŠ¥)</div>`;
      }

      async function loadAccount() {
        const d = await (await fetch(`/api/account?market=${market}`)).json();
        const a = d.account || {};
        const rt = d.runtime || {};
        const cards = [
          ["ì—°ê²° ìƒíƒœ", a.connected ? "connected" : "disconnected"],
          ["KRW ì”ê³ ", a.krw_balance ? `${num(a.krw_balance)} KRW` : "-"],
          ["ì½”ì¸ ìˆ˜ëŸ‰", a.coin_balance ?? "-"],
          ["í‰ê· ë‹¨ê°€", a.avg_buy_price ? `${num(a.avg_buy_price)} KRW` : "-"],
          ["ì½”ì¸ í‰ê°€ê¸ˆì•¡", a.coin_value ? `${num(a.coin_value)} KRW` : "-"],
          ["ì´ìì‚°", a.equity ? `${num(a.equity)} KRW` : "-"],
          ["DD Halt", rt.halted ? `ON (${rt.halt_reason || ""})` : "OFF"],
          ["ì—°ê°„ stop ìˆ˜", rt.yearly_stop_count ?? 0],
        ];
        document.getElementById("accountGrid").innerHTML = cards.map(([k, v]) => `<div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>`).join("");
      }

      async function refreshAll() {
        await Promise.all([loadOverview(), loadChart(), loadTrades(), loadReport(), loadNews(), loadAccount()]);
      }

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
          document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(btn.dataset.tab).classList.add("active");
          if (chart) chart.applyOptions({ width: chartEl.clientWidth });
        });
      });

      document.getElementById("refreshBtn").addEventListener("click", refreshAll);
      document.getElementById("interval").addEventListener("change", loadChart);
      document.getElementById("reportMode").addEventListener("change", loadReport);

      window.addEventListener("resize", () => { if (chart) chart.applyOptions({ width: chartEl.clientWidth }); });

      initChartSafe();
      refreshAll();
      setInterval(loadOverview, 15000);
      setInterval(loadTrades, 20000);
      setInterval(loadAccount, 20000);
    </script>
  </body>
</html>
