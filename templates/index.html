<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kiwi Trading Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="wrap">
      <header class="topbar">
        <div>
          <h1>키위 트레이딩 대시보드</h1>
          <p class="sub">{{ market }} · Toss/TradingView 스타일 모니터</p>
        </div>
        <div class="controls">
          <select id="interval">
            <option value="minute15">15m</option>
            <option value="minute60" selected>1h</option>
            <option value="minute240">4h</option>
            <option value="day">1D</option>
          </select>
          <button id="refreshBtn">새로고침</button>
        </div>
      </header>

      <section class="cards" id="overviewCards"></section>

      <section class="panel chart-panel">
        <div class="panel-title">가격 차트</div>
        <div id="chart"></div>
      </section>

      <section class="panel">
        <div class="panel-title">최근 거래 로그</div>
        <div id="tradeTable"></div>
      </section>
    </div>

    <script>
      const market = "{{ market }}";
      const chartEl = document.getElementById("chart");
      const chart = LightweightCharts.createChart(chartEl, {
        layout: { background: { color: "#0e1117" }, textColor: "#dbe2f0" },
        grid: { vertLines: { color: "#1f2430" }, horzLines: { color: "#1f2430" } },
        rightPriceScale: { borderColor: "#2a3142" },
        timeScale: { borderColor: "#2a3142" },
        width: chartEl.clientWidth,
        height: 460,
      });

      const candleSeries = chart.addCandlestickSeries({
        upColor: "#22c55e",
        downColor: "#ef4444",
        borderVisible: false,
        wickUpColor: "#22c55e",
        wickDownColor: "#ef4444",
      });

      const ma20Series = chart.addLineSeries({ color: "#60a5fa", lineWidth: 2 });
      const ma200Series = chart.addLineSeries({ color: "#f59e0b", lineWidth: 3 });
      const vwmaSeries = chart.addLineSeries({ color: "#a78bfa", lineWidth: 2 });

      async function loadOverview() {
        const res = await fetch(`/api/overview?market=${market}`);
        const d = await res.json();
        const a = d.account || {};
        const cards = [
          ["리스크 모드", `${d.risk_mode} (${d.risk_score ?? "-"})`],
          ["현재가", a.price ? `${Math.round(a.price).toLocaleString()} KRW` : "-"],
          ["총자산", a.equity ? `${Math.round(a.equity).toLocaleString()} KRW` : "-"],
          ["평가수익률", typeof a.pnl_pct === "number" ? `${a.pnl_pct.toFixed(2)}%` : "-"],
          ["최근 신호", `${d.latest_trade.side || "-"} @ ${d.latest_trade.time || "-"}`],
          ["거래횟수", `${d.trade_count} (buy ${d.buy_count} / sell ${d.sell_count})`],
        ];
        document.getElementById("overviewCards").innerHTML = cards
          .map(
            ([k, v]) => `<div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>`
          )
          .join("");
      }

      async function loadChart() {
        const interval = document.getElementById("interval").value;
        const res = await fetch(`/api/ohlcv?market=${market}&interval=${interval}&count=280`);
        const d = await res.json();
        if (!d.ok) return;

        candleSeries.setData(
          d.candles.map((x) => ({ time: x.time, open: x.open, high: x.high, low: x.low, close: x.close }))
        );
        ma20Series.setData(
          d.candles.filter((x) => x.ma20 !== null).map((x) => ({ time: x.time, value: x.ma20 }))
        );
        ma200Series.setData(
          d.candles.filter((x) => x.ma200 !== null).map((x) => ({ time: x.time, value: x.ma200 }))
        );
        vwmaSeries.setData(
          d.candles.filter((x) => x.vwma100 !== null).map((x) => ({ time: x.time, value: x.vwma100 }))
        );
      }

      async function loadTrades() {
        const res = await fetch(`/api/trades`);
        const d = await res.json();
        const rows = (d.rows || []).slice(0, 20);
        const html = [`<table><thead><tr><th>시간</th><th>구분</th><th>가격</th><th>점수</th><th>사유</th></tr></thead><tbody>`]
          .concat(
            rows.map(
              (r) =>
                `<tr><td>${r.time}</td><td>${r.side}</td><td>${Math.round(r.price || 0).toLocaleString()}</td><td>${r.score || 0}</td><td>${(r.reasons || []).join(", ")}</td></tr>`
            )
          )
          .concat(["</tbody></table>"])
          .join("");

        document.getElementById("tradeTable").innerHTML = html;
      }

      async function refreshAll() {
        await Promise.all([loadOverview(), loadChart(), loadTrades()]);
      }

      document.getElementById("refreshBtn").addEventListener("click", refreshAll);
      document.getElementById("interval").addEventListener("change", loadChart);

      window.addEventListener("resize", () => {
        chart.applyOptions({ width: chartEl.clientWidth });
      });

      refreshAll();
      setInterval(loadOverview, 15000);
      setInterval(loadTrades, 20000);
    </script>
  </body>
</html>
